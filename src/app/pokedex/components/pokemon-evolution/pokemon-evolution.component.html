<section class="card evolution-card">
  <h3 class="card-title">Evolution Chain</h3>

  @if (evolutionTree()) {
  <div class="evo-tree">
    <ng-container
      *ngTemplateOutlet="renderNode; context: { node: evolutionTree() }"
    ></ng-container>
  </div>
  }

  <ng-template #renderNode let-node="node">
    <!-- ðŸ”¥ CASO 1: EVOLUÃ‡ÃƒO PARALELA (SLOWPOKE, EEVEE, ETC.) -->
    @if (node.isParallel) {

    <!-- Pai -->
    <div class="evo-card parent">
      <img [src]="node.image" [alt]="node.name" class="evo-img" />
      <p class="evo-name">{{ node.name | titlecase }}</p>
    </div>

    <div class="arrow-wrapper">
      <span class="arrow">â†“</span>
    </div>

    <!-- Grid de filhos -->
    <div class="evo-grid" [ngClass]="node.layoutClass">
      @for (child of node.children; track child.name) {
      <ng-container
        *ngTemplateOutlet="renderNode; context: { node: child }"
      ></ng-container>
      }
    </div>
    }

    <!-- ðŸŸ£ CASO 1.5: FILHO ÃšNICO QUE TEM EVOLUÃ‡Ã•ES PARALELAS (Ralts â†’ Kirlia â†’ 2 evoluÃ§Ãµes) -->
    @else if (node.children?.length === 1 && node.children[0].isParallel) {

    <div class="evo-column">
      <!-- Pai -->
      <div class="evo-card small">
        <img [src]="node.image" [alt]="node.name" class="evo-img" />
        <p class="evo-name">{{ node.name | titlecase }}</p>
      </div>

      <div class="arrow-wrapper">
        <span class="arrow">â†“</span>
      </div>

      <!-- Filho (Kirlia) -->
      <div class="evo-card small">
        <img
          [src]="node.children[0].image"
          [alt]="node.children[0].name"
          class="evo-img"
        />
        <p class="evo-name">{{ node.children[0].name | titlecase }}</p>

        @if (node.children[0].details) {
        <p class="evo-details">{{ node.children[0].details }}</p>
        }
      </div>

      <div class="arrow-wrapper">
        <span class="arrow">â†“</span>
      </div>

      <!-- Grid com as evoluÃ§Ãµes paralelas -->
      <div class="evo-grid parallel">
        @for (child of node.children[0].children; track child.name) {
        <ng-container
          *ngTemplateOutlet="renderNode; context: { node: child }"
        ></ng-container>
        }
      </div>
    </div>
    }

    <!-- ðŸŸ¢ CASO 1.6: FILHO ÃšNICO, MAS ESSE FILHO TEM 2 EVOLUÃ‡Ã•ES COM 1 FINAL CADA (Wurmple) -->
    @else if ( node.children?.length === 1 && node.children[0].children?.length
    === 2 && node.children[0].children[0].children?.length === 1 &&
    node.children[0].children[1].children?.length === 1 ) {

    <div class="evo-column">
      <!-- Pai -->
      <div class="evo-card small">
        <img [src]="node.image" class="evo-img" />
        <p class="evo-name">{{ node.name | titlecase }}</p>
      </div>

      <div class="arrow-wrapper">
        <span class="arrow">â†“</span>
      </div>

      <!-- Grid com Silcoon e Cascoon -->
      <div class="evo-grid parallel-branches">
        @for (branch of node.children[0].children; track branch.name) {
        <div class="branch-column">
          <!-- IntermediÃ¡rio (Silcoon / Cascoon) -->
          <div class="evo-card small">
            <img [src]="branch.image" class="evo-img" />
            <p class="evo-name">{{ branch.name | titlecase }}</p>
          </div>

          <div class="arrow-wrapper small">
            <span class="arrow">â†“</span>
          </div>

          <!-- Final (Beautifly / Dustox) -->
          <ng-container
            *ngTemplateOutlet="
              renderNode;
              context: { node: branch.children[0] }
            "
          ></ng-container>
        </div>
        }
      </div>
    </div>
    }

    <!-- ðŸ”µ CASO 2: EVOLUÃ‡ÃƒO EM LINHA (CHARMANDER, ETC.) -->
    @else if (node.children?.length === 1) {

    <!-- CASO NORMAL EM LINHA -->
    <div class="evo-inline">
      <div class="evo-card small">
        <img [src]="node.image" [alt]="node.name" class="evo-img" />
        <p class="evo-name">{{ node.name | titlecase }}</p>
      </div>

      <span class="arrow-inline">â†’</span>

      <ng-container
        *ngTemplateOutlet="renderNode; context: { node: node.children[0] }"
      ></ng-container>
    </div>
    }

    <!-- ðŸ”¸ CASO 3: NÃ“ FINAL (SEM FILHOS) -->
    @else {
    <div class="evo-card">
      <img [src]="node.image" [alt]="node.name" class="evo-img" />
      <p class="evo-name">{{ node.name | titlecase }}</p>
      @if (node.details) {
      <p class="evo-details">{{ node.details }}</p>
      }
    </div>

    }
  </ng-template>
</section>
