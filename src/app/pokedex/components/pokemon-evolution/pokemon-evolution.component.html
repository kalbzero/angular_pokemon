<section class="card evolution-card">
  <h3 class="card-title">Evolution Chain</h3>

  @if (evolutionTree()) {
  <div class="evo-tree">
    <ng-container
      *ngTemplateOutlet="renderNode; context: { node: evolutionTree() }"
    ></ng-container>
  </div>
  }

  <ng-template #renderNode let-node="node">
    <!-- ðŸ”¥ CASO 1: EVOLUÃ‡ÃƒO PARALELA (SLOWPOKE, EEVEE, ETC.) -->
    @if (node.isParallel) {

    <!-- Pai -->
    <div class="evo-card parent" (click)="searchPokemonName(node.name)">
      <img [src]="node.image" [alt]="node.name" class="evo-img" />
      <p class="evo-name">{{ node.name | titlecase }}</p>
    </div>

    <div class="arrow-wrapper">
      <span class="arrow">â†™</span>
      <span class="arrow">â†˜</span>
    </div>

    <!-- Se for paralelo onde cada filho tem 1 final (Wurmple) -->
    @if (node.isParallelWithFinals) {
    <div class="evo-grid parallel-branches">
      @for (child of node.children; track child.name) {
      <div class="branch-column">
        <!-- intermediÃ¡rio (ex: Silcoon / Cascoon) -->
        <div class="evo-card small" (click)="searchPokemonName(child.name)">
          <img [src]="child.image" [alt]="child.name" class="evo-img" />
          <p class="evo-name">{{ child.name | titlecase }}</p>
          @if (child.details) {
          <p class="evo-details">{{ child.details }}</p>
          }
        </div>

        <div class="arrow-wrapper small">
          <span class="arrow">â†“</span>
        </div>

        <!-- final do ramo (ex: Beautifly / Dustox) -->
        <ng-container
          *ngTemplateOutlet="renderNode; context: { node: child.children[0] }"
        ></ng-container>
      </div>
      }
    </div>
    } @else {
    <!-- Caso paralelo normal: grid simples -->
    <div class="evo-grid" [ngClass]="node.layoutClass">
      @for (child of node.children; track child.name) {
      <ng-container
        *ngTemplateOutlet="renderNode; context: { node: child }"
      ></ng-container>
      }
    </div>
    } }

    <!-- ðŸŸ£ CASO 1.5: FILHO ÃšNICO QUE TEM EVOLUÃ‡Ã•ES PARALELAS (Ralts â†’ Kirlia â†’ 2 evoluÃ§Ãµes) -->
    @else if (node.children?.length === 1 && node.children[0].isParallel) {

    <div class="evo-column">
      <!-- Pai -->
      <div class="evo-card small" (click)="searchPokemonName(node.name)">
        <img [src]="node.image" [alt]="node.name" class="evo-img" />
        <p class="evo-name">{{ node.name | titlecase }}</p>
      </div>

      <div class="arrow-wrapper">
        <span class="arrow">â†“</span>
      </div>

      <!-- Filho (Kirlia) -->
      <div
        class="evo-card small"
        (click)="searchPokemonName(node.children[0].name)"
      >
        <img
          [src]="node.children[0].image"
          [alt]="node.children[0].name"
          class="evo-img"
        />
        <p class="evo-name">{{ node.children[0].name | titlecase }}</p>

        @if (node.children[0].details) {
        <p class="evo-details">{{ node.children[0].details }}</p>
        }
      </div>

      <div class="arrow-wrapper">
        <span class="arrow">â†™</span>
        <span class="arrow">â†˜</span>
      </div>

      <!-- Grid com as evoluÃ§Ãµes paralelas -->
      <div class="evo-grid parallel">
        @for (child of node.children[0].children; track child.name) {
        <ng-container
          *ngTemplateOutlet="renderNode; context: { node: child }"
        ></ng-container>
        }
      </div>
    </div>
    }

    <!-- ðŸ”µ CASO 2: EVOLUÃ‡ÃƒO EM LINHA (CHARMANDER, ETC.) -->
    @else if (node.children?.length === 1) {

    <!-- CASO NORMAL EM LINHA -->
    <div class="evo-inline">
      <div class="evo-card small" (click)="searchPokemonName(node.name)">
        <img [src]="node.image" [alt]="node.name" class="evo-img" />
        <p class="evo-name">{{ node.name | titlecase }}</p>
      </div>

      <span class="arrow-inline">â†’</span>

      <ng-container
        *ngTemplateOutlet="renderNode; context: { node: node.children[0] }"
      ></ng-container>
    </div>
    }

    <!-- ðŸ”¸ CASO 3: NÃ“ FINAL (SEM FILHOS) -->
    @else {
    <div class="evo-card" (click)="searchPokemonName(node.name)">
      <img [src]="node.image" [alt]="node.name" class="evo-img" />
      <p class="evo-name">{{ node.name | titlecase }}</p>
      @if (node.details) {
      <p class="evo-details">{{ node.details }}</p>
      }
    </div>

    }
  </ng-template>
</section>
